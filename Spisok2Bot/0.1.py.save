 import telebot
from telebot import TeleBot, types
import time
from openpyxl import Workbook, load_workbook
import time
import threading
from queue import Queue
import pandas as pd
from pathlib import Path
import re
from datetime import datetime
import random

bot = telebot.TeleBot("7970047574:AAEL7j4lsTYbRzE4dYa7YEm2LYSzZh2o-Pg")

#–î–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –Ω—É–º–º–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á
SOS = ["SOS", "TaskState"]  # –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é

#–î–ª—è –≤—Å–µ—Ö —Å–ª–æ–≤ –±–æ—Ç–∞
Hi = [
    "–ü—Ä–∏–≤–µ—Ç! –Ø —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫...\n–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º",
    "–ö–Ω–æ–ø–∫–∏",
    "–¢–µ–∫—Å—Ç",
    "–†–µ–∂–∏–º –≤—ã–±—Ä–∞–Ω ‚úÖ",
    "–•–æ—Ä–æ—à–æ, —Ç–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ\n–ï—Å–ª–∏ —Ç–≤–æ–∏—Ö –∑–∞–¥–∞—á—å –±–æ–ª—å—à–µ, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —á–∞—Ç",
    "–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å —Å–≤–æ–∏ –∑–∞–¥–∞—á–∏",
    "–≤–µ—Ä–Ω–æ?",
    "–ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–≤–æ–µ —á–∏—Å–ª–æ",
    "–ù–∞ –∫–∞–∫—É—é –¥–∞—Ç—É –ø–ª–∞–Ω?",
    "–ù–∞–ø–∏—à–∏—Ç–µ –¥–∞—Ç—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏",
    "–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω –Ω–∞–ø–∏—à–∏—Ç–µ:\n–ü–ª–∞–Ω\n1. –∑–∞–¥–∞—á–∞\n2. –∑–∞–¥–∞—á–∞",
    "–ù–∞–ø–∏—à–∏—Ç–µ –Ω–µ–ø—Ä–æ—à–µ–¥—à—É—é –¥–∞—Ç—É"
]

NoPlane = [
    "–ï—Å–ª–∏ —Ç–≤–æ–π –ø–ª–∞–Ω ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å, —Ç–æ —É —Ç–µ–±—è –∏–¥–µ–∞–ª—å–Ω—ã–π —à–∞–Ω—Å –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å –∏–¥–µ–∞–ª—å–Ω–æ",
    "–ö–æ–≥–¥–∞ —Ç–≤–æ–π –ø–ª–∞–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ –±—ã—Ç—å, –≤–µ—Å—å –¥–µ–Ω—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∏–¥–µ–∞–ª—å–Ω—ã–º –æ—Ç–ø—É—Å–∫–æ–º –æ—Ç —Å—É–µ—Ç—ã",
    "–ü–ª–∞–Ω –Ω–∏—á–µ–≥–æ ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –≥–¥–µ –ø–µ—Ä–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ",
    "–ï—Å–ª–∏ —Ç–≤–æ—è —Ü–µ–ª—å ‚Äî –Ω–∏—á–µ–≥–æ, —Ç–æ –∫–∞–∂–¥—ã–π —à–∞–≥ ‚Äî —ç—Ç–æ —É–∂–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ",
    "–•–æ—á–µ—à—å –±—ã—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º? –í—ã–ø–æ–ª–Ω–∏ –ø–ª–∞–Ω –Ω–∏—á–µ–≥–æ ‚Äî –∏ —Ç—ã —É–∂–µ –º–æ–ª–æ–¥–µ—Ü",
    "–ù–∏–∫–∞–∫–∏—Ö —Ç—Ä–µ–≤–æ–≥, –¥–µ–¥–ª–∞–π–Ω–æ–≤ –∏ —Å—Ç—Ä–µ—Å—Å–∞. –ü–ª–∞–Ω –Ω–∏—á–µ–≥–æ ‚Äî –ª—É—á—à–∏–π –∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç",
    "–ü–ª–∞–Ω –Ω–∏—á–µ–≥–æ ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ –∏–Ω–æ–≥–¥–∞ —Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Äî —ç—Ç–æ –æ—Ç–¥—ã—Ö–∞—Ç—å",
    "–ö–æ–≥–¥–∞ —Ç–≤–æ–π –ø–ª–∞–Ω ‚Äî –Ω–∏—á–µ–≥–æ, —Ç—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –≤—Å–µ–≥–æ",
    "–ù–µ –¥–µ–ª–∞—Ç—å ‚Äî —Ç–æ–∂–µ –¥–µ–π—Å—Ç–≤–∏–µ. –ù–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Äî —Ç–æ–∂–µ –ø–ª–∞–Ω",
    "–ü–ª–∞–Ω –Ω–∏—á–µ–≥–æ ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ –±—ã—Ç—å, –∞ –Ω–µ –∫–∞–∑–∞—Ç—å—Å—è",
    "–°–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π –ø–ª–∞–Ω? –ù–∏—á–µ–≥–æ –Ω–µ –∂–¥–∞—Ç—å ‚Äî –∏ —Ç–æ–≥–¥–∞ –≤—Å—ë –±—É–¥–µ—Ç –ø—Ä–∏—è—Ç–Ω—ã–º –±–æ–Ω—É—Å–æ–º"
]

lastTime = [
    "–ï—Å–ª–∏ —Ç–≤–æ–π –ø–ª–∞–Ω –Ω–∞ –≤—á–µ—Ä–∞ ‚Äî –Ω–∏—á–µ–≥–æ, –º–æ–∂–µ—à—å –Ω–µ –≤–Ω–æ—Å–∏—Ç—å –µ–≥–æ –≤ —Å–ø–∏—Å–æ–∫ –¥–µ–ª. –í—Å—ë —Ä–∞–≤–Ω–æ –¥–µ–¥–ª–∞–π–Ω —É–∂–µ –ø—Ä–æ–≤–∞–ª–µ–Ω. –ò–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω? üòâ",
    "–ó–∞–±—ã–ª –≤–Ω–µ—Å—Ç–∏ '–Ω–∏—á–µ–≥–æ' –≤ –ø–ª–∞–Ω –Ω–∞ –ø—Ä–æ—à–µ–¥—à–∏–π –¥–µ–Ω—å? –ù–µ –±–µ–¥–∞! –û–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ. ‚úÖ",
    "–ü—Ä–æ—à–µ–¥—à–∏–π –¥–µ–Ω—å –±–µ–∑ –ø–ª–∞–Ω–∞ ‚Äî —ç—Ç–æ –Ω–µ –ø—É—Å—Ç–æ—Ç–∞, –∞ —Å–≤–æ–±–æ–¥–∞. –ù–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–∏ —ç—Ç–æ –∫–∞–∫ –æ–ø—ã—Ç. üåø",
    "'–ù–∏—á–µ–≥–æ' –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –Ω–∞ –≤—á–µ—Ä–∞ ‚Äî –∑–Ω–∞—á–∏—Ç, –≤—Å—ë —É–∂–µ —Å–ª—É—á–∏–ª–æ—Å—å —Ç–∞–∫, –∫–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ. –ù–∏–∫–∞–∫–∏—Ö —É—Å–∏–ª–∏–π, —Ç–æ–ª—å–∫–æ –ø—Ä–∏–Ω—è—Ç–∏–µ. ‚òØÔ∏è",
    "–ï—Å–ª–∏ —Ç—ã –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª –Ω–∏—á–µ–≥–æ –Ω–∞ –¥–µ–Ω—å, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –ø—Ä–æ—à–µ–ª ‚Äî –∑–Ω–∞—á–∏—Ç, —Ç—ã –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –≤—ã–±—Ä–∞–ª –≥–∞—Ä–º–æ–Ω–∏—é. –ù–µ –Ω–∞—Ä—É—à–∞–π –µ—ë! üïäÔ∏è",
    "–¢—ã —Ö–æ—Ç–µ–ª –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å –≤ —Ç–æ—Ç –¥–µ–Ω—å? –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –¢—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–ª –ø–ª–∞–Ω, –¥–∞–∂–µ –Ω–µ –∑–∞–º–µ—Ç–∏–≤. –í—Å—ë –∏–¥—ë—Ç –ø–æ –≥—Ä–∞—Ñ–∏–∫—É! üéØ",
    "–ó–∞–±—ã–ª –¥–æ–±–∞–≤–∏—Ç—å '–Ω–∏—á–µ–≥–æ' –≤ –ø–ª–∞–Ω –Ω–∞ –ø—Ä–æ—à–ª—ã–π –≤—Ç–æ—Ä–Ω–∏–∫? –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π ‚Äî –æ–Ω–æ —Ç–∞–º –±—ã–ª–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. üòÑ",
    "–ü–ª–∞–Ω –Ω–∞ –ø—Ä–æ—à–µ–¥—à—É—é –¥–∞—Ç—É ‚Äî –∫–∞–∫ –ø—Ä–æ—à–ª–æ–µ: —á–µ–º –º–µ–Ω—å—à–µ –≤ –Ω—ë–º —Å—É–µ—Ç—ã, —Ç–µ–º —Å–ø–æ–∫–æ–π–Ω–µ–µ –Ω–∞—Å—Ç–æ—è—â–µ–µ. üìÖ",
    "–í—á–µ—Ä–∞—à–Ω–∏–π –ø–ª–∞–Ω ‚Äî –Ω–µ –ø—Ä–æ–≤–∞–ª. –≠—Ç–æ –ø–∏—Å—å–º–æ —Å–∞–º–æ–º—É —Å–µ–±–µ –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ. –ü–µ—Ä–µ—á–∏—Ç–∞–π –∏ —Ä–µ—à–∏: –æ—Ç–≤–µ—Ç–∏—à—å —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –æ—Ç–ø—É—Å—Ç–∏—à—å? ‚úâÔ∏è",
    "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª –Ω–∞ –≤—á–µ—Ä–∞? –û—Ç–ª–∏—á–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è! ‚ö°"
]

NFUC = ["NFUC","NFUC","NFUC","NFUC"]

NFUCs = [
    {"A": "NAME", "B": "SETINGS", "C": "do_this"}
]

FILE_PATH = "NFUW.xlsx" 
if Path(FILE_PATH).exists():
    df = pd.read_excel(FILE_PATH, engine="openpyxl")
    NFUCs = df.to_dict("records")  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º DataFrame –≤ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π
else:
    print("–û—à–∏–±–∫–∞ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏")

def get_random_message():
    return random.choice(messages_list)

def extract_dateA(text):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –¥–∞—Ç—É –∏–∑ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞"""
    # –ò—â–µ–º –¥–∞—Ç—É –≤ –ª—é–±–æ–π —á–∞—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞
    date_match = re.search(r'\d{1,2}\.\d{1,2}\.(?:\d{2}|\d{4})', text)
    if date_match:
        return date_match.group()
    return None
    
def extract_date(text):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YY –∏–ª–∏ DD.MM.YYYY, –∫–æ—Ç–æ—Ä–∞—è >= —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã"""
    words = text.split()[:3]  # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 —Å–ª–æ–≤–∞
    current_date = datetime.now()
    
    for word in words:
        # –î–æ–±–∞–≤–ª–µ–Ω—ã –≥—Ä–∞–Ω–∏—Ü—ã —Å–ª–æ–≤ \b
        if re.fullmatch(r'\b\d{1,2}\.\d{1,2}\.(?:\d{2}|\d{4})\b', word):
            try:
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—É—é –¥–∞—Ç—É –≤ datetime –æ–±—ä–µ–∫—Ç
                if len(word.split('.')[-1]) == 2:  # –≥–æ–¥ –∏–∑ –¥–≤—É—Ö —Ü–∏—Ñ—Ä
                    text_date = datetime.strptime(word, '%d.%m.%y')
                else:  # –≥–æ–¥ –∏–∑ —á–µ—Ç—ã—Ä–µ—Ö —Ü–∏—Ñ—Ä
                    text_date = datetime.strptime(word, '%d.%m.%Y')
                
                # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∞—Ç—ã (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º—è, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—ã)
                if text_date.date() >= current_date.date():
                    return word
                else:
                    continue  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥—Ä—É–≥–∏–µ —Å–ª–æ–≤–∞
                    
            except ValueError:
                # –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
                continue
    return None

exclude_words = ["–ø–ª–∞–Ω", "plane", "/plane", "plane in", "plane for", "–ø–ª–∞–Ω –Ω–∞"]
wor = ["–Ω–∞", "for", "in"]

specS = "!"                              #–≠—Ç–æ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª –¥–ª—è –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è —Ç–æ–≥–æ —á–µ–º –æ–±–æ–∑–Ω–∞—á–∞—é—Ç—Å—è –∑–∞–¥–∞—á–∏ –ø—Ä–∏–¥—É–º–∞–π –∫–∞–∫ —ç—Ç–æ –∑–∞–Ω–µ—Å—Ç–∏ –≤ start
pTT2 = fr'{specS}\s*([^\n{specS}]*?)(?=\s*{specS}|$)'

def format_text(text):
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –¥–∞—Ç—ã
    original_text = text
    
    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
    text = ' '.join(text.split())
    
    # –ò—â–µ–º –¥–∞—Ç—É –≤ —Ç–µ–∫—Å—Ç–µ
    date_pattern = r'\b\d{1,2}\.\d{1,2}\.(?:\d{2}|\d{4})\b'
    date_match = re.search(date_pattern, text)
    date_str = date_match.group() if date_match else ""
    
    # –£–¥–∞–ª—è–µ–º –¥–∞—Ç—É –∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á
    if date_str:
        text = re.sub(re.escape(date_str), '', text)
    
    # –ò—â–µ–º –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
    pattern1 = r'(?<!\S)(\d+)[\.\)\*/][\s*]*([^\n]*?)(?=\s*(?:\d+[\.\)\*/][\s*]*|~|$))'
    
    # –ü–∞—Ä—Å–∏–º –∑–∞–¥–∞—á–∏
    tasks1 = re.findall(pattern1, text)
    numbered_tasks = [(num, task.strip()) for num, task in tasks1 if task.strip()]
    
    tasks2 = re.findall(pTT2, text)
    special_tasks = [task.strip() for task in tasks2 if task.strip()]
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    result = ""
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –¥–∞—Ç–æ–π –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if date_str:
        result = f"–ü–ª–∞–Ω –Ω–∞ {date_str}:\n"
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–¥–∞—á–∏
    if numbered_tasks:
        corrected_tasks = []
        expected_number = 1
        
        for original_num, task in numbered_tasks:
            try:
                current_num = int(original_num)
                corrected_tasks.append((expected_number, task))
                expected_number += 1
            except ValueError:
                corrected_tasks.append((expected_number, task))
                expected_number += 1
        
        for number, task in corrected_tasks:
            result += f"{number}) {task}\n"
    
    elif special_tasks:
        for i, task in enumerate(special_tasks, 1):
            result += f"{i}) {task}\n"
    
    else:
        return None  # –ï—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ—Ç
    
    return result

#–ù–∞ –ø–ª–∞–Ω
@bot.message_handler(func=lambda message: (NFUC[0] in ["Button", "Text"]) and (any(keyword.lower() in message.text.lower() for keyword in exclude_words)))
def ide_plan1(message):
    user_id = message.from_user.id  #—ç—Ç–æ id —á–µ–ª–ª–∞
    new_entry = {"A": user_id, "B": NFUC[0], "C": NFUC[1]}
    user_entry = next((entry for entry in NFUCs if entry.get("A") == user_id), None)
    current_date = datetime.now().strftime("%d.%m.%Y")

    markuP = types.InlineKeyboardMarkup()
    markuP.row(
        types.InlineKeyboardButton("–î–∞", callback_data="IDE_P1_Y"),
        types.InlineKeyboardButton("–ù–µ—Ç", callback_data="IDE_P1_N")
    )

    mtD = " ".join([word for word in message.text.split()
                   if word.lower() not in [w.lower() for w in exclude_words]])

    formatted_text = format_text(mtD)
    exdate = extract_date(message.text)
    randomNo = random.choice(NoPlane)

    if not formatted_text or formatted_text.isspace():
        bot.send_message(message.chat.id, randomNo)
        bot.send_message(message.chat.id, Hi[10])
    else:
        if exdate is not None:
            if exdate:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ exdate –Ω–µ None –∏ –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
                termo = re.escape(exdate)
                mtD = re.sub(termo, '', mtD).strip()
            else:
                mtD = mtD.strip()
            if not mtD or mtD.isspace():
                bot.send_message(message.chat.id, randomNo)
                bot.send_message(message.chat.id, Hi[10])
            else:
                if any(word in mtD.lower() for word in wor):
                    if not formatted_text or formatted_text.isspace() or not mtD or mtD.isspace():
                        bot.send_message(message.chat.id, randomNo)
                        bot.send_message(message.chat.id, Hi[10])
                    else:
                        NFUC[3] = formatted_text
                        bot.send_message(message.chat.id, NFUC[3])
                        #–≠–¢–û –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –í –¢–ê–ë–õ–ò–¶–£
                        user_entry = next((entry for entry in NFUCs if entry.get("A") == user_id), None)
                        if not user_entry:
                            NFUCs.append(new_entry)
                            pd.DataFrame(NFUCs).to_excel(FILE_PATH, engine="openpyxl", index=False) 
                        else:
                            plan_columns = [col for col in user_entry.keys() if col not in ['A', 'B'] and str(col).isdigit()]
                            if plan_columns:
                                #–ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–±—Ü–∞ —Å –ø–ª–∞–Ω–∞–º–∏
                                max_plan_col = max(int(col) for col in plan_columns)
                                next_plan_col = str(max_plan_col + 1)
                            else:
                                next_plan_col = "2"
                            user_entry[next_plan_col] = f"–ü–ª–∞–Ω –Ω–∞ {exdate}:\n{NFUC[3]}"
                            user_entry["B"] = NFUC[0]
                            user_entry["C"] = NFUC[1]
                        pd.DataFrame(NFUCs).to_excel(FILE_PATH, engine="openpyxl", index=False)
                    print(NFUCs)
                else:
                    pattern = '|'.join(map(re.escape, wor))
                    mtD = re.sub(pattern, '', mtD).strip()
                    NFUC[1] = f"–ü–ª–∞–Ω –Ω–∞ {exdate}:\n{mtD}"
                    bot.edit_message_text(NFUC[1], chat_id=message.chat.id, message_id=message.message_id)
        else:
            NFUC[3] = formatted_text
            NFUC[1] = current_date
            EXNF = extract_dateA(NFUC[3])
            if EXNF and EXNF in NFUC[3]:
                # –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ
                bot.send_message(message.chat.id, NFUC[3])
            else:
                # –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ—Ç
                bot.send_message(message.chat.id, f"–ü–ª–∞–Ω –Ω–∞ {NFUC[1]}?", reply_markup=markuP)

@bot.callback_query_handler(func=lambda call: call.data.startswith("IDE_P1"))
def call_P1(call):
    if call.data == "IDE_P1_Y":
        NFUC[2] = "callback_PY"
        NFUC[1] = f"–ü–ª–∞–Ω –Ω–∞ {NFUC[1]}:\n{NFUC[3]}"
        bot.edit_message_text(NFUC[1], chat_id=call.message.chat.id, message_id=call.message.message_id)
    if call.data == "IDE_P1_N":
        NFUC[2] = "callback_PN"
        bot.send_message(call.message.chat.id, Hi[9])
    button(call.message)

@bot.message_handler(func=lambda message: NFUC[2] == "callback_PN")
def CLN(message):
    user_id = message.from_user.id  #—ç—Ç–æ id —á–µ–ª–ª–∞
    new_entry = {"A": user_id, "B": NFUC[0], "C": NFUC[3]}
    exdate = extract_date(message.text)
    randomNo = random.choice(NoPlane)
    randomTime = random.choice(lastTime)

    if not message.text or message.text.isspace():
        bot.send_message(message.chat.id, randomNo)
        bot.send_message(message.chat.id, Hi[10])
    else:
        if exdate:
            #–≠–¢–û –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –í –¢–ê–ë–õ–ò–¶–£
            user_entry = next((entry for entry in NFUCs if entry.get("A") == user_id), None)
            if not user_entry:
                NFUCs.append(new_entry)
                pd.DataFrame(NFUCs).to_excel(FILE_PATH, engine="openpyxl", index=False) 
            else:
                plan_columns = [col for col in user_entry.keys() if col not in ['A', 'B'] and str(col).isdigit()]
                if plan_columns:
                    #–ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–±—Ü–∞ —Å –ø–ª–∞–Ω–∞–º–∏
                    max_plan_col = max(int(col) for col in plan_columns)
                    next_plan_col = str(max_plan_col + 1)
                else:
                    next_plan_col = "2"
                user_entry[next_plan_col] = f"–ü–ª–∞–Ω –Ω–∞ {exdate}:\n{NFUC[3]}"
                user_entry["B"] = NFUC[0]
                user_entry["C"] = NFUC[1]
                pd.DataFrame(NFUCs).to_excel(FILE_PATH, engine="openpyxl", index=False)
                NFUC[3] = user_entry[next_plan_col]
                bot.send_message(message.chat.id, NFUC[3])
            print(NFUCs)
        else:
            exdate = "None"
            bot.send_message(message.chat.id, randomTime)
            bot.send_message(message.chat.id, Hi[11])

@bot.message_handler(func=lambda message: NFUC and NFUC[0] == "SETINGS" and any(keyword in message.text for keyword in ["–ò–¥–µ—è", "–∏–¥–µ—è", "Idea", "idea"]))
def ide_plan2(message):
    bot.send_message(message.chat.id, "SAE2")

@bot.callback_query_handler(func=lambda call: call.data == "edit_text1" )
def callback_buttons(call):
    SOS[0] = "edit_text1"  # –ò–∑–º–µ–Ω—è–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞
    bot.edit_message_text(Hi[3], chat_id=call.message.chat.id, message_id=call.message.message_id)
    button(call.message)  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º –∫–Ω–æ–ø–æ–∫

@bot.callback_query_handler(func=lambda call: call.data == "edit_text2")
def callback_text(call):
    SOS[0] = "edit_text2"  # –ò–∑–º–µ–Ω—è–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞
    bot.edit_message_text(Hi[3], chat_id=call.message.chat.id, message_id=call.message.message_id)
    text(call.message)  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º

@bot.message_handler(commands=["start"])
def start(message):
    global specS
    specS = "!" 
    user_id = message.from_user.id 
    # –ò—â–µ–º –∑–∞–ø–∏—Å—å, –≥–¥–µ –≤ —Å—Ç–æ–ª–±—Ü–µ "A" (–∏–ª–∏ –¥—Ä—É–≥–æ–º) –µ—Å—Ç—å user_id
    user_entry = next((entry for entry in NFUCs if entry.get("A") == user_id), None)
    if user_entry:
        NFUC[0] = user_entry["B"]

    SOS[0] = "SOS"  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    user_id = message.from_user.id  #—ç—Ç–æ id —á–µ–ª–ª–∞

    markup = types.InlineKeyboardMarkup()
    markup.row(
        types.InlineKeyboardButton(Hi[1], callback_data="edit_text1"),
        types.InlineKeyboardButton(Hi[2], callback_data="edit_text2")
    )
    bot.send_message(message.chat.id, Hi[0], reply_markup=markup)

#–ó–¥–µ—Å—å –∫–æ–¥ –¥–ª—è —Ä–µ–∂–∏–º–∞ –∫–Ω–æ–ø–æ–∫
@bot.message_handler(func=lambda message: SOS[0] == "edit_text1")
def button(message):
    NFUC[0] = "Button"
    markup1 = types.InlineKeyboardMarkup()
    markup1.row(
        types.InlineKeyboardButton("1", callback_data="task1"),
        types.InlineKeyboardButton("2", callback_data="task2"),
        types.InlineKeyboardButton("3", callback_data="task3"),
        types.InlineKeyboardButton("4", callback_data="task4"),
        types.InlineKeyboardButton("5", callback_data="task5")
    )
    if SOS[0] == "edit_text1":
        SOS[0] = "SOS"
        bot.send_message(message.chat.id, Hi[4], reply_markup=markup1)
        return

@bot.message_handler(func=lambda message: NFUC and NFUC[0] == "Button")
def button2(message):
    if SOS[0] == "SOS" and message.text.isdigit():
        task_num = message.text
        markup2 = types.InlineKeyboardMarkup()
        markup2.row(
            types.InlineKeyboardButton("–î–∞", callback_data=f"task{task_num}"),
            types.InlineKeyboardButton("–ù–µ—Ç", callback_data="t_button")
        )
        SOS[0] = f"task{task_num}"
        SOS[1] = f"{task_num}"
        bot.send_message(message.chat.id, text=f"{message.text} {Hi[6]}", reply_markup=markup2)
    
    for i in range(1, 10000):
        if SOS[1] == f"{i}" and SOS[0] == "t_but":
            SOS[0] = "call"
            SOS[1] = f"{i}"
            break

    for i in range(1, 10000):
        if SOS[1] in [f"{i}"] and SOS[0] == "call":
            SOS[0] = "SOS"
            SOS[1] = f"{i}"     
            break

@bot.callback_query_handler(func=lambda call: call.data.startswith("task"))
def callback_task(call):
    SOS[0] = "task"
    SOS[1] = f"{call.data}"
    bot.edit_message_text(Hi[3], chat_id=call.message.chat.id, message_id=call.message.message_id)
    for i in range(1, 10000):
        if call.data == f"task{i}": #call.data —ç—Ç–æ –∫–∞–∫ message.text
            SOS[0] = "call"
            SOS[1] = f"{i}"
            break

    button2(call.message)      #–°–£–ü–ï–† –ù–ê–î–û —Å—Ç–∞–≤—å —ç—Ç—É —Ç–µ–º—É –≤—Ä–æ–¥–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞

@bot.callback_query_handler(func=lambda call: call.data.startswith("t_button")) #–≠–¢–û –ü–ò–®–ò –ù–ê –ù–ï–¢
def callback_task(call):
    SOS[0] = "t_but"
    bot.edit_message_text(Hi[7], chat_id=call.message.chat.id, message_id=call.message.message_id)
    button2(call.message)

#–ó–¥–µ—Å—å –∫–æ–¥ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
@bot.message_handler(func=lambda message: SOS[0] == "edit_text2")
def text(message):
    bot.send_message(message.chat.id, "text2")
    NFUC[0] = "Text"
    SOS[0] = "SOS"

bot.infinity_polling()
